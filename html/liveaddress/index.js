define(['regularjs', 'jquery', '../../javascript/base/util', '../../html/liveaddress/index.html', '../../javascript/3rd/clipboard.js', '../../javascript/widget/tip.js', '../../javascript/widget/dialog.js', '../../html/sliderbar/index.js', '../../javascript/3rd/base64.js', '../../javascript/base/const.js', '../../javascript/3rd/cookie.js'], function(Regular, $, util, index, Clipboard, tip, dialog, sliderbar, Base64, api, cookie) {    require('../../css/liveaddress.css')    return Regular.extend({        template: '<sliderbarTpl pro = {user}>' + index + '</sliderbarTpl>',        data: {            //登陆账户密码            user: {                nick: '',                icon: '',                type: 2 //左侧导航栏模块标识            },            config: {                title: '', //标题                snapshotUrl: '', //封面图                description: '', //简介                isEncrypt: 0,                password: '', //md5播放密码                companyId: '',                 deviceId: '', // 设备id                cameraName: '', //设备名称                delFlag: 1, //播放状态                pageId: '',                url: 'http://localhost:9999/play.html?id=' + this.data.config.pageId //直播地址            },            show: {                check: false, //直播设置选中                radioCheck: false //播放密码是否有            },            error: {                titleError: '',                infoError: '',                pwdError: ''            }        },        init: function() {            this.initCtrol();            this.render();        },        /**         * 初始化控件         */        initCtrol: function() {            var self = this;            //提示框            this.tip = util.tip();            //复制            var clipboard = new Clipboard('#copyAddress');            clipboard.on('success', function(e) {                self.tip.showSuccessTip('复制成功');                e.clearSelection();            });            clipboard.on('error', function(e) {                self.tip.showErrorTip('复制失败');            });        },        render: function() {            this.data.config.deviceId = Base64.decode(util.getQueryString('id'));            this.data.config.cameraName = Base64.decode(util.getQueryString('name'));            this.data.config.url = this.data.config.url + util.getQueryString('id');            console.info(this.data.config.deviceId);            var self = this;            util.rest(api.LIVEWEB.get, {                param: {                    deviceId: this.data.config.deviceId                },                method: 'post',                onload: function(data) {                    console.info('成功', data);                    if (data.pageId) {                        self.initData(data);                    } else {                        //第一次进入时无pageId 手动调一把保存生成pageId                        self.save('save', true);                    }                },                onerror: function(data) {                    console.info('牺牲', data);                }            })        },        initData: function(data) {            self.data.config.title = data.title;            self.data.config.pageId = data.pageId;            self.data.config.snapshotUrl = data.snapshotUrl;            self.data.config.description = data.description;            self.data.config.isEncrypt = data.isEncrypt;            self.data.config.password = data.password;            self.data.config.delFlag = data.delFlag;            self.$update();        },        /**         * 暂停/恢复直播         */        playStatus: function() {            var self = this,                url = '',                param = {};            if (this.data.config.delFlag) {                url = api.LIVEWEB.pause;                param = {                    deviceId: this.data.config.deviceId                }            } else {                url = api.LIVEWEB.addOrUpdate;                param = this.verify();                param.delFlag = 1;            }            util.rest(url, {                param: param,                method: 'post',                onload: function(data) {                    console.info('成功', data);                    self.tip.showSuccessTip('设置成功');                    self.data.config.delFlag = self.data.config.delFlag ? false : true;                    self.$update();                },                onerror: function(data) {                    console.info('牺牲', data);                    self.tip.showErrorTip('设置失败，请稍后重试');                    self.data.config.delFlag = self.data.config.delFlag ? false : true;                    self.$update();                }            })        },        /**         * 上传封面图         */        upload: function() {            if (!this.data.show.check || this.data.config.delFlag) {                return;            }            document.getElementById('file').click()        },        /**         * 上传分享图片         */        imgChange: function(event) {            var fd = new FormData(),                uuid = util.uuid(),                self = this;            console.info('uuid', uuid)            fd.append('file', event.origin.files[0]);            fd.append('fileKey', uuid);            /*//创建xhr            var xhr = new XMLHttpRequest();            //fd.append("acttime", new Date().toString()); //本人喜欢在参数中添加时间戳，防止缓存（--、）            //进度条部分            xhr.upload.onprogress = function (evt) {                console.info('evt', evt.loaded)                if (evt.lengthComputable) {                    var percentComplete = Math.round(evt.loaded * 100 / evt.total);                }            };            xhr.open("POST", api.LIVEWEB.upload, true);            xhr.send(fd);            xhr.onreadystatechange = function () {                console.info(999)                if (xhr.readyState == 4 && xhr.status == 200) {                    var result = xhr.responseText;                }            }                        return;*/            var xhrOnProgress = function(fun) {                xhrOnProgress.onprogress = fun; //绑定监听                //使用闭包实现监听绑                return function() {                    //通过$.ajaxSettings.xhr();获得XMLHttpRequest对象                    var xhr = $.ajaxSettings.xhr();                    //判断监听函数是否为函数                    if (typeof xhrOnProgress.onprogress !== 'function')                        return xhr;                    //如果有监听函数并且xhr对象支持绑定时就把监听函数绑定上去                    if (xhrOnProgress.onprogress && xhr.upload) {                        xhr.upload.onprogress = xhrOnProgress.onprogress;                    }                    return xhr;                }            }            $.ajax({                url: api.LIVEWEB.upload,                type: 'POST',                beforeSend: function(xhr) {                    if (cookie.get('token') && cookie.get('uid')) {                        xhr.setRequestHeader("token", cookie.get('token'));                        xhr.setRequestHeader("uid", cookie.get('uid'));                    }                },                xhr: xhrOnProgress(function(e) {                    console.log(9999998, e);                    var percent = e.loaded / e.total; //计算百分比                }),                cache: false,                data: fd,                processData: false,                contentType: false            }).done(function(data) {                console.info('res', data)            }).fail(function(data) {                console.info('djj', data)                self.tip.showErrorTip('失败');            });        },        /**         * 清空图片上传         */        picDel: function() {            this.data.generateData.shareData.imgUrl = '';            $('#fileUrl').val('');            this.$update();        },        /**         * 校验保存输入         */        verify: function() {            console.info('verify', this.data.config)            var reg = /^\d{1,6}$/,                verifyResult = false; //不超过6位的纯数字            if (util.getBytesLength(util.trim(this.data.config.title)) > 20) {                this.data.error.titleError = '请输入不超过20字的标题';                verifyResult = true;            }            if (util.getBytesLength(util.trim(this.data.config.description)) > 200) {                this.data.error.infoError = '请输入不超过200字的简介';                verifyResult = true;            }            if (this.data.config.isEncrypt && !util.trim(this.data.config.password)) {                this.data.error.pwdError = '密码不能为空！';                verifyResult = true;            }else if (this.data.config.isEncrypt && !reg.test(this.data.config.password)) {                this.data.error.pwdError = '请输入不超过6位的纯数字密码';                verifyResult = true;            }            if (verifyResult) {                this.$update();                return verifyResult;            }            return {                title: this.data.config.title, //标题                snapshotUrl: this.data.config.snapshotUrl, //封面图                description: this.data.config.description, //简介                isEncrypt: this.data.config.isEncrypt,                password: this.data.config.password, //md5播放密码                companyId: this.data.config.companyId,                deviceId: this.data.config.deviceId // 设备id            }        },        /**         * 保存/清除设置         * @param  {String} type save: 保存设置；clear: 清除设置         */        save: function(type, init) {            if (!this.data.show.check || this.data.config.delFlag) {                return;            }            var self = this,                result;            this.data.error = {                titleError: '',                infoError: '',                pwdError: ''            }            if (type == 'save') {                result = this.verify();                console.info(11,result)                if (result === true) {                    return;                }                util.rest(api.LIVEWEB.addOrUpdate, {                    param: result,                    method: 'post',                    onload: function(data) {                        console.info('成功', data);                        if (init) {                            self.initData(data);                        } else {                            self.tip.showSuccessTip('保存成功');                        }                    },                    onerror: function(data) {                        console.info('牺牲', data);                        self.tip.showErrorTip('保存失败，请稍后再试');                    }                })            } else {                //清除设置                util.rest(api.LIVEWEB.addOrUpdate, {                    param: {                        title: '', //标题                        snapshotUrl: '', //封面图                        description: '', //简介                        isEncrypt: '',                        password: '', //md5播放密码                        companyId: '',                        deviceId: this.data.config.deviceId // 设备id                    },                    method: 'post',                    onload: function(data) {                        console.info('成功', data);                        this.data.config.title = ''; //标题                        this.data.config.snapshotUrl = ''; //封面图                        this.data.config.description = ''; //简介                        this.data.config.isEncrypt = '';                        this.data.config.password = ''; //md5播放密码                        this.data.config.companyId = '';                        self. $update();                        self.tip.showSuccessTip('清除成功');                    },                    onerror: function(data) {                        console.info('牺牲', data);                        self.tip.showErrorTip('保存失败，请稍后再试');                    }                })            }        }    });});