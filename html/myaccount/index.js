/** * 我的账户页面 */define(['regularjs', 'jquery', '../../javascript/base/util', '../../html/myaccount/index.html', '../../javascript/widget/tip.js', '../../javascript/widget/dialog.js', '../../html/sliderbar/index.js', '../../javascript/base/const.js'], function(Regular, $, util, index, tip, dialog, sliderbar, api) {    require('../../css/myaccount.css')    return Regular.extend({        template: '<sliderbarTpl pro = {user}>' + index + '</sliderbarTpl>',        data: {            //登陆账户密码            user: {                nick: '游客考拉',                icon: '',                type: 5 //左侧导航栏模块标识            }        },        init: function() {            this.initCtrol();            this.render();        },        /**         * 初始化控件         * @return {[type]} [description]         */        initCtrol: function() {            //提示框2            this.tip = util.tip();        },        /**         *  渲染页面         */        render: function() {            util.rest(api.USER.getAlertInfo, {                param: {},                method: 'post',                onload: function(data) {                    console.info('成功',data);                },                onerror: function(data) {                    console.info('牺牲',data);                }            })        },        /**         * 修改手机号         */        setPhone: function() {            var self = this,                phoneList = [12312, 22222, 3333, 22, 34]; //手机号码列表            //弹出框            var setPhoneDialog = new dialog({                data: {                    pro: {                        id: 'setPhone',                        single: false,                        singleCenter: true, //一个居中按钮                        title: '添加手机号',                        confirmBtnText: '下一步',                        confirmCallback: function() {                            console.info(222, this);                            setPhoneDialog.sendAddPhone(this);                        },                        reset: {                            addPhone: '', //增加的手机号码                            verifyCode: '', //验证码                            timeOut: 0, //发送                            sendMsg: '获取验证码' //文案                        },                        show: {                            errmsg: ''                        }                    }                },                template: '<diglogTpl pro={pro}>\                                <p class="add-dialog-text">请输入新的手机号码：</p>\                                <div class="add-dialog-box">\                                    <input type="text" class="add-dialog-input" r-model={pro.reset.addPhone} placeholder="请输入手机">\                                </div>\                                <div class="add-dialog-code-box u-cb">\                                    <input type="text" class="code-input u-ftl" placeholder="请输入收到的验证码" r-model={pro.reset.verifyCode}>\                                    <span id="sendPhoneCode" class="verify-btn u-ftl {pro.reset.timeOut ? \'u-white-btn-disabled\' : \'u-white-btn\'}" on-click={this.sendCode()}>{#if pro.reset.timeOut}{pro.reset.sendMsg}（{pro.reset.timeOut}）{#else}{pro.reset.sendMsg}{/if}</span>\                                </div>\                                <div class="add-dialog-box2">\                                    <div class="u-error-type" r-hide={!pro.show.errmsg}>\                                        <p class="error-icon">{pro.show.errmsg}</p>\                                    </div>\                                </div>\                                </diglogTpl>',                /**                 * 获取验证码                 */                sendCode: function() {                    var self2 = this;                    if (self2.data.pro.reset.timeOut) return;                    if (!util.trim(this.data.pro.reset.addPhone)) {                        self2.data.pro.show.errmsg = '手机号不能为空';                        return;                    }                    if (util.verify('phone', this.data.pro.reset.addPhone)) {                        self2.data.pro.show.errmsg = '手机号不合法';                        return;                    }                    self2.data.pro.reset.sendMsg = '重新发送';                                        //发送验证码请求                    util.rest(api.USER.getSmsCode, {                        param: {mobile: this.data.pro.reset.addPhone},                        method: 'post',                        onload: function(data) {                            console.info('成功',data);                            if (data && typeof data != undefined) {                                self2.data.pro.reset.timeOut = 60;                                self2.timer();                                self2.$update();                            }                        },                        onerror: function(data) {                            console.info('牺牲');                            self2.data.pro.reset.timeOut = 60;                            self2.timer();                            self2.$update();                        }                    });                },                /**                 * 倒数计时                 */                timer: function() {                    var self = this;                    if (!document.getElementById('sendPhoneCode')) { //如果弹出框已销毁则停止定时                        clearTimeout(self.__timer);                        return;                    }                    this.__timer = setTimeout(function() {                        self.data.pro.reset.timeOut--;                        console.info(self.data.pro.reset.timeOut)                        if (self.data.pro.reset.timeOut === 0) {                            clearTimeout(self.__timer);                        } else {                            self.timer();                        }                        self.$update();                    }, 1000);                },                /**                 * 添加手机号发送请求                 * @param  {Obj} obj setPhoneDialog对象                 */                sendAddPhone: function(obj) {                    if (!obj.pro.reset.addPhone) {                        obj.pro.show.errmsg = '手机号不能为空1';                        obj.isClose = false;                        return;                    }                    if (util.verify('phone', obj.pro.reset.addPhone)) {                        obj.pro.show.errmsg = '手机号不合法';                        obj.isClose = false;                        return;                    }                    if (!obj.pro.reset.verifyCode) {                        obj.pro.show.errmsg = '验证码不能为空';                        obj.isClose = false;                        return;                    }                    obj.isClose = true;                    //发送添加手机号请求                    var param = {mobile: obj.pro.reset.addPhone, code: obj.pro.reset.verifyCode};                    console.info(param)                    util.rest(api.USER.setAlertMobile, {                        param: param,                        method: 'post',                        onload: function(data) {                            console.info('成功',data);                            if (data && typeof data != undefined) {                                setPhoneDialog.addPhoneSuccess(data, obj.pro.reset.addPhone);                            }                        },                        onerror: function(data) {                            console.info('牺牲',data);                            //todo                            setPhoneDialog.addPhoneSuccess(data, obj.pro.reset.addPhone);                        }                    });                },                /**                 * 添加号码成功                 * @param  {JSON} data    添加成功回调                 * @param  {String} phone 需要添加的手机号码                 */                addPhoneSuccess: function(data, phone) {                    var hideName = util.hideName(phone, 3, 2, 8),                        addPhoneSuccessDialog = new dialog({                            data: {                                pro: {                                    id: 'addPhoneSuccess',                                    singleCenter: true, //一个居中按钮                                    title: '添加手机号',                                    confirmBtnText: '确定',                                    confirmCallback: function() {                                        console.info(this);                                    }                                }                            },                            template: '<diglogTpl pro={pro}>\                                    <span class="success-icon"></span>\                                    <p class="success-text2">已成功添加手机号：<span class="success-text3">' + hideName + '</span></p>\                                </diglogTpl>'                        });                    addPhoneSuccessDialog.$inject('body');                }            });            setPhoneDialog.$inject('body');        }    });});